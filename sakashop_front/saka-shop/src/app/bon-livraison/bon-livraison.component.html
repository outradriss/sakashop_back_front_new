<div class="invoice-container">
    <header>
      <h2>Gestion des Bons de Livraison</h2>
      <button class="btn-primary" (click)="openForm()">‚ûï Nouveau Bon de Livraison</button>
    </header>
  
    <!-- ‚úÖ Barre de recherche -->
    <div class="search-bar">
      <input
        type="text"
        placeholder="üîç Rechercher par R√©f√©rence ou Client..."
        [(ngModel)]="searchQuery"
        (input)="filterBL()"
        class="search-input"
      />
    </div>
  
    <div class="invoice-content">
      <table class="invoice-table">
        <thead>
          <tr>
            <th>R√©f√©rence</th>
            <th>Client</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bl of filteredBonsLivraison">
            <td>{{ bl.reference }}</td>
            <td>{{ bl.clientName }}</td>
            <td>{{ bl.dateLivraison | date: 'dd/MM/yyyy' }}</td>
            <td>
              <button class="btn-edit" (click)="modifierBL(bl)">‚úèÔ∏è</button>
              <button class="btn-delete" (click)="supprimerBL(bl.id)">üóëÔ∏è</button>
              <button class="btn-print" (click)="imprimerBL(bl)">üñ®Ô∏è</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- ‚úÖ POPUP BL -->
  <div *ngIf="formPopup" class="modal" id="bl-container">
    <div class="modal-content">
      <span class="close" (click)="closeForm()">&times;</span>
      <h3>{{ isEditMode ? 'Modifier Bon de Livraison' : 'Nouveau Bon de Livraison' }}</h3>
  
      <form>
        <label>R√©f√©rence :</label>
        <input type="text" [(ngModel)]="blReference" name="reference" readonly />
  
        <label>Client existant :</label>
        <select [(ngModel)]="selectedClientId" name="clientSelect" (change)="onClientSelected()">
          <option value="">-- S√©lectionner un client --</option>
          <option *ngFor="let client of clients" [value]="client.id">
            {{ client.name }} - {{ client.ice }}
          </option>
        </select>
  
        <label>Nouveau client :</label>
        <input type="text" placeholder="Nom du nouveau client" [(ngModel)]="nouveauClientNom" name="nouveauClientNom" />
  
        <label>Nom :</label>
        <input type="text" placeholder="Nom du client" [(ngModel)]="clientName" name="clientName" />
  
        <label>ICE :</label>
        <input type="text" placeholder="ICE du client" [(ngModel)]="clientICE" name="clientICE" />
  
        <label>Adresse :</label>
        <input type="text" placeholder="Adresse du client" [(ngModel)]="adresse" name="adresse" />
  
        <label>Date de Livraison :</label>
        <input type="date" [(ngModel)]="dateLivraison" name="dateLivraison" required />
  
        <div class="change-search-section">
          <label>Ajouter un produit</label>
          <input
            type="text"
            placeholder="Rechercher un produit par code barre ou r√©f√©rence..."
            [(ngModel)]="discountSearchQuery"
            (input)="filterDiscountProducts()"
            name="discountSearchQuery"
          />
  
          <div class="product-list-container" *ngIf="discountFilteredProducts.length > 0">
            <ul class="product-list">
              <li *ngFor="let product of discountFilteredProducts.slice(0, 50)" (click)="selectProduct(product)">
                {{ product.name }} - {{ product.salesPrice | currency:'MAD' }}
              </li>
            </ul>
          </div>
        </div>
  
        <div class="selected-products-container">
          <table class="selected-products">
            <thead>
              <tr>
                <th>Produit</th>
                <th>Quantit√©</th>
                <th>Prix H.T.</th>
                <th>TVA (%)</th>
                <th>Prix T.T.C.</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of produitsSelectionnes; let i = index">
                <td>{{ item.produit.name }}</td>
                <td>
                    <input
                      type="number"
                      [(ngModel)]="item.quantite"
                      name="quantite-{{i}}"
                      min="1"
                      [max]="item.produit.quantity"
                      (input)="checkStock(item)"
                    />
                    <div *ngIf="item.quantite >= item.produit.quantity" class="error-message">
                      Stock max disponible : {{ item.produit.quantity }}
                    </div>
                  </td>
                  
                <td>
                  <input
                    type="number"
                    [(ngModel)]="item.produit.buyPrice"
                    name="prixht-{{i}}"
                    min="0"
                    step="0.01"
                    (input)="updateTTC(item)"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    [(ngModel)]="item.produit.tva"
                    name="tva-{{i}}"
                    min="0"
                    step="1"
                    (input)="updateTTC(item)"
                  />
                </td>
                <td>
                  {{
                    ((+item.produit.buyPrice + (+item.produit.buyPrice * +item.produit.tva / 100)) * item.quantite)
                      | number: '1.2-2'
                  }} MAD
                </td>
                <td>
                  <button class="btn-delete" (click)="removeProduct(i)">üóëÔ∏è</button>
                </td>
              </tr>
              <tr *ngIf="produitsSelectionnes.length === 0">
                <td colspan="6" class="text-center">Aucun produit s√©lectionn√©</td>
              </tr>
            </tbody>
          </table>
        </div>
  
        <button type="submit" class="btn-primary-ajout" (click)="generateBLAndPrint()">
          Imprimer et {{ isEditMode ? 'Mettre √† jour' : 'Ajouter' }} le BL
        </button>
        <button type="button" class="btn-secondary" (click)="closeForm()">Annuler</button>
      </form>
    </div>
  </div>
  