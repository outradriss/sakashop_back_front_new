<div class="pos-container">
 
<!-- Liste des Produits -->
<div class="product-list">
  <h3>Produits Disponibles</h3>
  <!-- Barre de Recherche -->
  <div class="search-bar">
    <input 
      type="text" 
      placeholder="Rechercher un produit ou scanner un code-barres..." 
      [(ngModel)]="searchQuery" 
      (input)="filterProducts()" 
    />
  </div>
  <div class="products">
    <div 
      class="product-card" 
      *ngFor="let product of filteredProducts; let i = index" 
      (click)="addToCart(product)"
    >
      <div class="product-details">
        <h4>
          {{ product.name }}
          <span *ngIf="product.isPromo" class="promo-star">‚≠ê</span>
        </h4>
        <div *ngIf="product.isPromo; else regularPrice">

             <!-- Prix avec promotion -->
             <h6>Prix sans promo</h6>
             <p>{{ product.salesPrice | currency : 'MAD ':'symbol':'1.2-2' }}</p>
             <h5>Prix avec promo</h5>
             <p class="promo-price">{{ product.pricePromo | currency : 'MAD ':'symbol':'1.2-2' }}</p>
           </div>
           <!-- Prix sans promotion -->
           <ng-template #regularPrice>
             <p>{{ product.salesPrice | currency : 'MAD ':'symbol':'1.2-2' }}</p>
           </ng-template>
         </div>
       </div>
     </div>      
     <div class="navigation-buttons">
      <button class="btn-logout" (click)="lockCaisse()">Lock caisse</button>
      <button class="btn-logout" (click)="openCloseCaissePopup()">Fermeture de caisse</button>
      <button class="btn-orders" (click)="openSalesPopup()">Liste des commandes</button>
    </div>
    <!-- ‚úÖ Popup de fermeture de caisse -->
<div class="close-caisse-popup-overlay" *ngIf="isCloseCaissePopupOpen">
  <div class="close-caisse-popup">
    <div class="close-caisse-header">
      <h3>üõí R√©sum√© des ventes</h3>
      <button class="close-caisse-btn-close" (click)="isCloseCaissePopupOpen = false">‚úñ</button>
    </div>

    <!-- ‚úÖ Tableau des ventes -->
    <div class="sales-table-container">
      <table class="sales-table">
        <thead>
          <tr>
            <th>code barre</th>
            <th>Produit</th>
            <th>Quantit√©</th>
            <th>Prix</th>
            <th>t.Paiement</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let sale of sales">
            <td>{{ sale.itemCode }}</td>
            <td>{{ sale.itemName }}</td>
            <td>{{ sale.quantity }}</td>
            <td>
              <ng-container *ngIf="sale.negoPrice === -1">
                0 MAD (produit avec 100% de promo)
              </ng-container>
              <ng-container *ngIf="sale.negoPrice !== -1">
                {{ sale.salesPrice | currency:'MAD' }}
              </ng-container>
            </td>                       
            <td>{{ sale.typePaiement }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ‚úÖ Actions -->
    <div class="close-caisse-footer">
      <p class="total-label">üí∞ Total: {{ calculateTotalSales() | currency:'MAD' }}</p>
      <button class="btn-print" (click)="closeCaisse()">üñ®Ô∏è Imprimer Ticket</button>
      <button class="btn-cancel" (click)="isCloseCaissePopupOpen = false">‚ùå Annuler</button>
    </div>
  </div>
</div>


<!-- Modale personnalis√©e pour la liste des commandes -->
<div class="orders-popup-overlay" *ngIf="isPopupVisible">
  <div class="orders-popup">
    <div class="orders-popup-header">
      <h3>Commandes du jour</h3>
      <!-- Bouton "X" reste rouge -->
      <button class="orders-btn-close-imprim" (click)="closeSalesPopup()">X</button>
    </div>

    <div class="orders-popup-body">
      <div class="orders-card" *ngFor="let sale of filteredSales">
        <p><strong>ID :</strong> {{ sale.idOrderChange }}</p>
        <p><strong>Date :</strong> {{ sale.dateOrder | date: 'dd/MM/yyyy HH:mm' }}</p>
        <!-- Appelle la m√©thode d'impression et ferme le popup -->
        <button class="orders-btn-print" (click)="printAndClose(sale)">Imprimer</button>
      </div>
    </div>
  </div>
</div>
</div>



<!-- Overlay -->
<div *ngIf="isLocked" class="overlay">
  <div class="unlock-container">
    <!-- Bouton Unlock caisse -->
    <button *ngIf="!showPasswordInput" (click)="showPasswordInput = true">
      Unlock caisse
    </button>
    
    <!-- Formulaire de saisie du mot de passe -->
 <div *ngIf="showPasswordInput">
  <input 
    type="password" 
    placeholder="Entrer le mot de passe" 
    [(ngModel)]="password"
  />
  <button (click)="unlockCaisse()" [disabled]="!password">Valider</button>
  <!-- Message d'erreur -->
  <p *ngIf="errorMessage" style="color: red; margin-top: 10px;">
    {{ errorMessage }}
  </p>
</div>
  </div>
</div>
   
<!-- ‚úÖ Panier -->
<div class="cart">
  <h3>Panier</h3>
  <div class="cart-items">
    <div class="cart-item" *ngFor="let product of cart">
      <div class="cart-details">
        <p class="product-name">{{ product.name }}</p>
        <p *ngIf="product.isPromo; else normalPrice">
          Prix avec promo :
          <input
            type="number"
            readonly
            [(ngModel)]="product.negoPrice"
            [ngModel]="product.negoPrice || product.pricePromo" 
            (input)="validateCartPrice(product)"
            [class.invalid]="product.negoPrice < product.pricePromo"
            min="0.01"
          />
        </p>
        <ng-template #normalPrice>
          Prix :
          <input
            type="number"
            readonly
            [(ngModel)]="product.negoPrice"
            [ngModel]="product.negoPrice || product.salesPrice || product.pricePromo" 
            (input)="validateCartPrice(product)"
            min="0.01"
          />
        </ng-template>
        <p class="stock-info">Stock disponible : {{ product.quantity }}</p>
        <p>Quantit√© : <strong>{{ product.quantityInCart }}</strong></p>
      </div>

      <!-- ‚úÖ Actions du panier -->
      <div class="cart-actions">
        <button (click)="increaseQuantity(product)" class="btn-action">‚ûï</button>
        <button (click)="decreaseQuantity(product)" class="btn-action">‚ûñ</button>
        <button (click)="removeFromCart(product)" class="btn-action btn-remove">‚ùå</button>
        <button (click)="openDiscountPopup(product)" class="btn-action btn-discount">üí∞ Remise</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Pop-up de remise -->
  <div *ngIf="selectedProductForDiscount" class="discount-popup-overlay">
    <div class="discount-popup">
      <h4>Appliquer une remise</h4>
      <p><strong>Prix original :</strong> {{ selectedProductForDiscount.salesPrice | currency: 'MAD' }}</p>
      
      <label for="discountPercentage">Ajoutez la remise :</label>
      <input
        type="number"
        id="discountPercentage"
        [(ngModel)]="discountPercentage"
        min="0"
        max="100"
        (input)="calculateDiscountedPrice()"
      />

      <p><strong>Prix apr√®s remise :</strong> {{ discountedPrice | currency: 'MAD' }}</p>

      <div class="discount-actions">
        <button (click)="applyDiscount()" class="btn-apply">‚úî Appliquer</button>
        <button (click)="closeDiscountPopup()" class="btn-cancel">‚ùå Annuler</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Totaux -->
  <div class="totals">
    <h4>Total : {{ calculateTotal() | currency: 'MAD ':'symbol':'1.2-2' }}</h4>
  </div>

  <!-- ‚úÖ Boutons d'actions -->
  <div class="actions">
    <button class="btn-pay" (click)="showPaymentPopup()">Payer</button>
    <button class="btn-cancel" (click)="cancel()" [disabled]="cart.length === 0">Annuler</button>
    <button class="btn-change-product" (click)="showChangeProductPopup()" [disabled]="cart.length === 0">Changer Produit</button>
    <button class="btn-other-payment" (click)="showOtherPaymentPopup()" [disabled]="cart.length === 0">Autre M√©thode de Paiement</button>
  </div>
</div>




<!-- Popup Changer Produit -->
<div *ngIf="isChangeProductPopupOpen" class="change-product-popup">
  <div class="change-product-popup-content">
    
    <!-- Produit √† changer -->
    <div class="change-product-section">
      <h3>Produit √† remplacer</h3>
      <p class="change-old-product"><strong>Nom :</strong> {{ selectedProductToChange.name }}</p>
      <p class="price-blue"><strong>Prix :</strong> {{ selectedProductToChange.salesPrice | currency: 'MAD' }}</p>
    </div>

    <!-- Recherche de commande par ID -->
    <div class="change-order-search-section">
      <label for="orderId" class="change-label">Entrer l'ID de la commande :</label>
      <div class="change-search-container">
        <input
          id="orderId"
          type="text"
          class="change-search-input"
          [(ngModel)]="orderId"
          placeholder="Ex: 123456"
        />
        <button class="change-search-btn" (click)="getOrder()">Rechercher</button>
      </div>
    </div>

<!-- Affichage du message d'erreur si le produit n'existe pas dans la commande -->
<p class="error-message" *ngIf="productNotFound">
  ‚ö†Ô∏è Le produit √† remplacer n'est pas trouv√© dans la commande.
</p>

    <!-- Affichage des d√©tails de la commande -->
    <div *ngIf="foundOrder && foundOrder.items.length > 0" class="change-order-details">
      <p><strong>Date de la commande :</strong> {{ foundOrder.items[0].dateCommande | date: 'dd/MM/yyyy HH:mm' }}</p>

      <!-- Alerte si la commande d√©passe 3 jours -->
      <p class="change-alert" *ngIf="isOrderExpired">‚ö†Ô∏è Cette commande date de plus de 3 jours.</p>
    </div>

  <!-- S√©lection du nouveau produit (d√©sactiv√©e si productNotFound = true) -->
<div class="change-search-section">
  <h4>Rechercher un nouveau produit</h4>
  <input 
    type="text" 
    class="change-search-input"
    placeholder="Saisir un nom ou scanner un code-barres..." 
    [(ngModel)]="discountSearchQuery" 
    (input)="filterProductsChange()" 
    [disabled]="productNotFound"  
  />

  <!-- Masquer la liste des produits si `productNotFound === true` -->
  <ul class="change-dropdown-list" *ngIf="discountFilteredProducts.length > 0 && !productNotFound">
    <li
      class="change-dropdown-item"
      *ngFor="let product of discountFilteredProducts.slice(0, 4)"
      (click)="selectProduct(product)"
    >
      {{ product.name }} - {{ product.salesPrice | currency: 'MAD' }}
    </li>
  </ul>
</div>

    <!-- D√©tails du produit s√©lectionn√© et diff√©rence de prix -->
    <div *ngIf="selectedNewProduct" class="change-difference-section">
      <h4>Nouveau produit s√©lectionn√©</h4>
      <p><strong>Nom :</strong> {{ selectedNewProduct.name }}</p>
      <p class="price-red"><strong>Prix :</strong> {{ selectedNewProduct.salesPrice | currency: 'MAD' }}</p>

      <div *ngIf="priceDifference !== null" class="change-price-difference-container">
        <h4>Diff√©rence de prix</h4>
        <p class="price-red" *ngIf="priceDifference > 0">
          ‚ûï Le client doit ajouter <strong>{{ priceDifference | currency: 'MAD' }}</strong>.
        </p>
        <p class="price-red" *ngIf="priceDifference < 0">
          ‚ûñ Vous devez rembourser <strong>{{ (-priceDifference) | currency: 'MAD' }}</strong> au client.
        </p>
        <p class="price-equal" *ngIf="priceDifference === 0">
          ‚úÖ Aucun paiement ou remboursement n√©cessaire.
        </p>
      </div>
    </div>

    <!-- Actions -->
    <div class="change-popup-actions">
      <button (click)="confirmProductChange()" [disabled]="!selectedNewProduct" class="change-confirm-btn">‚úî Confirmer</button>
      <button (click)="cancelProductChange()" class="change-cancel-btn">‚ùå Annuler</button>
    </div>

  </div>
</div>



<!-- Popup Autre M√©thode de Paiement -->
<div *ngIf="isOtherPaymentPopupOpen" class="popup">
  <div class="popup-content">
    <h3>Autre M√©thode de Paiement</h3>

    <label>Montant en Esp√®ce :</label>
    <input type="number" [(ngModel)]="cashAmount" (input)="calculateRemainingPayment()" min="0" />

    <label>Montant √† payer par Carte :</label>
    <input type="number" [(ngModel)]="cardAmount" (input)="calculateRemainingPayment()" min="0" />

    <label>Montant en Ch√®que :</label>
    <input type="number" [(ngModel)]="chequeAmount" (input)="calculateRemainingPayment()" min="0" />

    <p *ngIf="remainingAmount < 0" class="error-message">
      ‚ùå Le total d√©passe le montant √† payer de <strong>{{ (-remainingAmount) | currency: 'MAD' }}</strong>
    </p>
    <p *ngIf="remainingAmount > 0" class="warning-message">
      ‚ö†Ô∏è Il manque <strong>{{ remainingAmount | currency: 'MAD' }}</strong> pour compl√©ter le paiement.
    </p>

    <div class="popup-actions">
      <button (click)="pay()" [disabled]="remainingAmount !== 0">Confirmer</button>
      <button (click)="isOtherPaymentPopupOpen = false">Annuler</button>
    </div>
  </div>
</div>

       


<!-- Popup de s√©lection du mode de paiement avec calculatrice -->
<div *ngIf="isPaymentPopupVisible" class="custom-payment-popup-overlay">
  <div class="custom-payment-popup-content">
    <h3>S√©lectionner le Mode de Paiement</h3>

    <!-- Modes de paiement -->
    <div class="custom-payment-options">
      <label class="custom-payment-option custom-payment-cash">
        Esp√®ces
        <input type="radio" name="typePaiement" value="esp√®ces" [(ngModel)]="selectedPaymentMethod" />
      </label>
      <label class="custom-payment-option custom-payment-card">
        Carte
        <input type="radio" name="typePaiement" value="carte" [(ngModel)]="selectedPaymentMethod" />
      </label>
      <label class="custom-payment-option custom-payment-cheque">
        Ch√®que
        <input type="radio" name="typePaiement" value="cheque" [(ngModel)]="selectedPaymentMethod" />
      </label>
    </div>

    <!-- Ligne de s√©paration -->
    <div class="custom-separator"></div>

    <!-- Calculatrice de paiement -->
    <div class="custom-payment-calculator">
      <h4>Total √† payer : <strong>{{ calculateTotal() | currency : 'MAD ':'symbol':'1.2-2'}}</strong></h4>

      <label>Montant donn√© par le client :</label>
      <input 
        type="number" 
        [(ngModel)]="amountGiven" 
        (input)="calculateChange()" 
        min="0" 
        placeholder="Saisir le montant donn√©" 
        class="custom-calculator-input"
      />

      <p *ngIf="change >= 0" class="custom-change-due">
        üè¶ Monnaie √† rendre : <strong>{{ change | currency : 'MAD ':'symbol':'1.2-2' }}</strong>
      </p>
      <p *ngIf="change < 0" class="custom-error-message">
        ‚ùå Montant insuffisant ! Il manque <strong>{{ (-change) | currency : 'MAD ':'symbol':'1.2-2' }}</strong>
      </p>
    </div>

    <!-- Boutons -->
    <div class="custom-popup-actions">
      <button class="custom-btn-confirm" (click)="confirmPayment()" [disabled]="change < 0">Continuer</button>
      <button class="custom-btn-cancel" (click)="closePaymentPopup()">Annuler</button>
    </div>
  </div>
</div>


      
<!-- Popup alert -->
<div *ngIf="isPopupVisibledelete" class="cancel-popup-overlay">
 <div class="cancel-popup-content">
   <label for="cancelReason">Pourquoi voulez-vous annuler la commande ?</label>
   <input type="text" id="cancelReason" [(ngModel)]="cancelReason" placeholder="Entrez votre raison ici..." />
   <div class="cancel-popup-actions">
     <button class="btn-submit" (click)="submitCancel()">Soumettre</button>
     <button class="btn-cancel" (click)="closeCancelPopupDelete()">Fermer</button>
   </div>
 </div>
</div>
     
<!-- Alerte globale en haut de la page
<div *ngIf="alerts.length > 0" class="global-alert">
 <div class="alert-content">
   <span>{{ alerts[0].message }}</span>
   <button class="alert-btn" (click)="showPopup()">En savoir +</button>
   <button class="close-btn" (click)="dismissAlert(alerts[0])">X</button>
 </div>
</div>-->

<!-- Popup alert 
<div *ngIf="isPopupVisible" class="popup-overlay">
 <div class="popup-content">
   <button class="close-btn" (click)="closePopup()">X</button>
   <h3>Produits proches de l'expiration</h3>
   <ul>
     <li *ngFor="let product of expiringProducts">
       <strong>{{ product.name }}</strong> - Expire le {{ product.expiredDate }}
     </li>
   </ul>
   <button class="action-btn" (click)="closePopup()">Fermer</button>
 </div>
</div>-->

<!-- Modal de Confirmation -->
<div class="modal" *ngIf="isModalOpen">
 <div class="modal-content">
   <h3>Confirmer le Paiement</h3>
   <p>Voulez-vous confirmer et imprimer le bon ?</p>
   <div class="modal-actions">
     <button class="btn-confirm" (click)="confirmPayment()">Oui</button>
     <button class="btn-cancel" (click)="closeModal()">Non</button>
   </div>
 </div>
</div>
</div>
