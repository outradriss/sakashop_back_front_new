<div  class="invoice-container">
    <header>
        <h2>Gestion des Factures</h2>
        <button class="btn-primary" (click)="openForm()">‚ûï Nouvelle Facture</button>
    </header>
    <div class="search-bar">
        <input
          type="text"
          placeholder="üîç Rechercher par r√©f√©rence ou client..."
          [(ngModel)]="searchQuery"
          (input)="filtrerFactures()"
        />
      </div>
    <div class="invoice-content">
        <!-- Tableau des factures -->
        <table class="invoice-table">
            
              
            <thead>
                <tr>
                    <th>R√©f√©rence</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Total (MAD)</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let facture of factures">
                    <td>{{ facture.reference }}</td>
                    <td>{{ facture.clientName }}</td>
                    <td>{{ facture.dateFacture | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ facture.totalTTC | currency: 'MAD' }}</td>
                    <td>
                        <span [ngClass]="{'badge paid': facture.statusPaiement === 'pay√©e', 'badge pending': facture.statusPaiement === 'en attente'}">
                            {{ facture.statusPaiement }}
                        </span>
                    </td>
                    <td>
                        <button class="btn-edit" (click)="modifierFacture(facture)">‚úèÔ∏è</button>
                        <button class="btn-delete" (click)="supprimerFacture(facture.id)">üóëÔ∏è</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>    

<!-- ‚úÖ POPUP FACTURE PLEIN √âCRAN -->
<div id="invoice-container" *ngIf="formPopup" class="modal">
    <div class="modal-content">
        <span class="close" (click)="closeForm()">&times;</span>
        <h3>{{ isEditMode ? 'Modifier Facture' : 'Nouvelle Facture' }}</h3>
        <form>
            <label>R√©f√©rence :</label>
            <input type="text" [(ngModel)]="factureReference" name="reference" readonly>            
        
            
            <label>Client :</label>
            <input type="text" placeholder="Nom du client" required name="client" [(ngModel)]="clientName">
            
            <label>ICE de client :</label>
            <input type="text" placeholder="ICE de client" required name="ICE de client" [(ngModel)]="clientICE">
            
            <label>Code Client :</label>
            <input type="text" placeholder="Code Client" required name="clientCode" [(ngModel)]="clientCode">
            
            <label>Adresse de client :</label>
            <input type="text" placeholder="Adresse de client " required name="Adresse de client" [(ngModel)]="adresse">
            
            <label>Entreprise client :</label>
            <input type="text" placeholder="Entreprise client " required name="entreprise client" [(ngModel)]="entreprise">

        
            <label>Date de Facture :</label>
            <input type="date" required name="dateFacture" [(ngModel)]="dateFacture">

            <label>Date d'√âch√©ance :</label>
            <input type="date" required name="dateEcheance" [(ngModel)]="dateEcheance">

        
            <!-- ‚úÖ Champ de recherche produit -->
    <div class="change-search-section">
        <label>Ajouter un produit</label>
        <input
            type="text"
            placeholder="Rechercher un produit par code barre ou reference..."
            [(ngModel)]="discountSearchQuery"
            (input)="filterDiscountProducts()"
            name="discountSearchQuery"
        />
            
        <!-- ‚úÖ Liste des produits avec un scroll et max 4 √©l√©ments -->
        <div class="product-list-container" *ngIf="discountFilteredProducts.length > 0">
            <ul class="product-list">
                <li *ngFor="let product of discountFilteredProducts.slice(0, 50)" (click)="selectProduct(product)">
                    {{ product.name }} - {{ product.salesPrice | currency:'MAD' }}
                </li>
            </ul>
        </div>
    </div>
<!-- ‚úÖ Liste des produits s√©lectionn√©s avec v√©rification -->
<div class="selected-products-container">
    <table class="selected-products">
        <thead>
            <tr>
                <th>Produit</th>
                <th>Quantit√©</th>
                <th>Prix H.T.</th>
                <th>TVA (%)</th>
                <th>Prix T.T.C.</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let item of produitsSelectionnes; let i = index">
                <td>{{ item.produit.name }}</td>

                <td>
                    <input
                        type="number"
                        [(ngModel)]="item.quantite"
                        min="1"
                        [max]="item.produit.quantity"
                        name="quantite-{{i}}"
                        (input)="checkStock(item)"
                    />
                    <div *ngIf="item.quantite >= item.produit.quantity" class="error-message">
                        La quantit√© de stock est {{ item.produit.quantity }}
                    </div>
                </td>

                <td>
                    <input
                        type="number"
                        [(ngModel)]="item.produit.buyPrice"
                        name="prixht-{{i}}"
                        min="0"
                        step="0.01"
                        (input)="updateTTC(item)"
                    />
                </td>

                <td>
                    <input
                        type="number"
                        [(ngModel)]="item.produit.tva"
                        name="tva-{{i}}"
                        min="0"
                        step="1"
                        (input)="updateTTC(item)"
                    />
                </td>

                <td>{{ (+item.produit.buyPrice) + ((+item.produit.buyPrice) * (+item.produit.tva) / 100) | number:'1.2-2' }} MAD</td>
                <td>{{ item.quantite * ((+item.produit.buyPrice) + ((+item.produit.buyPrice) * (+item.produit.tva) / 100)) | currency:'MAD' }}</td>
                
                <td>
                    <button class="btn-delete" (click)="removeProduct(i)">üóëÔ∏è</button>
                </td>
            </tr>

            <tr *ngIf="produitsSelectionnes.length === 0">
                <td colspan="7" class="text-center">Aucun produit s√©lectionn√©</td>
            </tr>
        </tbody>
    </table>
</div>




<label>Mode de Paiement :</label>
<select required name="modePaiement" [(ngModel)]="modePaiement">
    <option value="">S√©lectionnez un mode de paiement</option>
    <option value="CB">Carte Bancaire</option>
    <option value="cheque">Ch√®que</option>
    <option value="virement">Virement</option>
    <option value="espece">Esp√®ce</option>
    <option value="uknown">vide</option>
</select>
<label>statut de Paiement :</label>
<select required name="statusPaiement" [(ngModel)]="statusPaiement">
    <option value="">S√©lectionnez un status de paiement</option>
    <option value="pay√©">pay√©</option>
    <option value="non pay√©">non pay√©</option>
</select>

          <!-- ‚úÖ Total bien visible -->
<div class="total-container">
    <h4>Montant Total:</h4>
    <span class="total-amount">{{ calculTotal() | currency:'MAD' }}</span>
</div>      
<button type="submit" class="btn-primary-ajout" (click)="generateInvoiceAndPrint()">
    Imp et {{ isEditMode ? 'Mettre √† jour' : 'Ajouter' }} la facture
  </button>
              <button type="button" class="btn-secondary" (click)="closeForm()">Annuler</button>
        </form>
        
    </div>
</div>

